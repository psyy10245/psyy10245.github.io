<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>사업 아이디어 허브 (로그인/결제/광고/관리자)</title>

  <!-- 기본 보안/운영 헤더(정적 호스팅 한계 내) -->
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <!-- CSP는 AdSense/Firebase/CDN 때문에 완전 엄격하게 하면 깨질 수 있어, 최소 형태만 -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' https: data: blob:;
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https: blob:;
          style-src 'self' 'unsafe-inline' https:;
          img-src 'self' https: data: blob:;
          connect-src 'self' https: wss:;
          frame-src https:;
        ">

  <style>
    :root { --bg:#0b0f14; --card:#121a23; --text:#e9eef5; --muted:#9fb0c3; --accent:#5ad1ff; --bad:#ff6b6b; --ok:#65ffb8; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial; background:var(--bg); color:var(--text); }
    a { color:var(--accent); text-decoration:none; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 18px; background:#081019; border-bottom:1px solid #1b2a3a; position:sticky; top:0; z-index:10; }
    .brand { font-weight:800; letter-spacing:.2px; }
    .nav { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn { background:#0f2436; color:var(--text); border:1px solid #274158; padding:10px 12px; border-radius:12px; cursor:pointer; }
    .btn:hover { border-color:#3a6b8f; }
    .btn.primary { background: linear-gradient(135deg, #0f3b57, #0a2a40); border-color:#3a6b8f; }
    .btn.danger { background:#2a0f14; border-color:#6a2a35; color:#ffd9d9; }
    .pill { padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #2a4257; color:var(--muted); }
    .grid { display:grid; grid-template-columns: 1.4fr .6fr; gap:14px; align-items:start; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }
    .card { background:var(--card); border:1px solid #1b2a3a; border-radius:18px; padding:16px; }
    .card h2 { margin:0 0 8px; font-size:18px; }
    .muted { color:var(--muted); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .list { display:grid; gap:10px; margin-top:10px; }
    .item { border:1px solid #1b2a3a; border-radius:14px; padding:12px; background:#0e1620; }
    .item .title { font-weight:700; }
    .tag { font-size:12px; padding:3px 8px; border:1px solid #2a4257; border-radius:999px; color:var(--muted); }
    .input, textarea, select { width:100%; background:#09131d; color:var(--text); border:1px solid #22364a; border-radius:12px; padding:10px 12px; outline:none; }
    textarea { min-height:110px; resize:vertical; }
    .hr { height:1px; background:#1b2a3a; margin:14px 0; }
    .small { font-size:12px; }
    .ok { color:var(--ok); }
    .bad { color:var(--bad); }
    .kpi { display:grid; grid-template-columns: repeat(3,1fr); gap:10px; }
    @media (max-width: 700px){ .kpi{ grid-template-columns:1fr; } }
  </style>

  <!-- AdSense 스크립트: AdSense 승인 후 client 값 넣으면 활성화 (선택) -->
  <!-- 참고: AdSense 표준 코드/태그 예시는 Google 문서를 따르세요. -->
  <!-- https://developers.google.com/adsense/platforms/direct/ad-tags -->
</head>
<body>
  <div class="topbar">
    <div class="row">
      <div class="brand">사업 아이디어 허브</div>
      <span id="envPill" class="pill">GitHub Pages + Firebase + Stripe Link</span>
    </div>
    <div class="nav">
      <a class="btn" href="#/">홈</a>
      <a class="btn" href="#/pricing">결제</a>
      <a class="btn" href="#/submit">아이디어 제출</a>
      <a class="btn" href="#/admin">관리자</a>
      <span id="userPill" class="pill">로그아웃 상태</span>
      <button id="loginBtn" class="btn primary">Google 로그인</button>
      <button id="logoutBtn" class="btn danger" style="display:none;">로그아웃</button>
    </div>
  </div>

  <div class="wrap">
    <div id="app"></div>
  </div>

  <script type="module">
    /********************************************************************
     * 0) 사용자가 채워야 하는 설정값
     ********************************************************************/
    const CONFIG = {
      // (필수) Firebase 웹앱 설정 (Firebase 콘솔 > 프로젝트 설정 > 웹 앱)
      firebaseConfig: {
        apiKey: "FILL_ME",
        authDomain: "FILL_ME",
        projectId: "FILL_ME",
        storageBucket: "FILL_ME",
        messagingSenderId: "FILL_ME",
        appId: "FILL_ME",
      },

      // (권장) 관리자 이메일 allowlist (여기에 본인 구글 계정 이메일 넣기)
      adminEmails: [
        "admin@example.com"
      ],

      // (결제) Stripe Payment Link (Dashboard에서 미리 만들어 붙이기)
      // 서버 없이 바로 결제 페이지 제공 가능 (단, 결제 검증/권한부여 자동화는 서버리스가 필요)
      stripePaymentLink: "https://buy.stripe.com/REPLACE_ME",

      // (광고) AdSense (승인 후 사용)
      adsenseClient: "ca-pub-REPLACE_ME",
      adsenseSlot: "REPLACE_ME",
      enableAds: false, // true로 바꾸면 광고 슬롯 렌더링 시도
    };

    /********************************************************************
     * 1) GitHub Pages 한계: 서버 비밀키/서버 로직 불가
     * - GitHub Pages는 서버사이드 언어를 지원하지 않음(정적 호스팅).
     * - 따라서 Stripe secret key 같은 비밀키는 절대 프론트에 넣지 말 것.
     ********************************************************************/

    /********************************************************************
     * 2) Firebase SDK (모듈)
     ********************************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
      serverTimestamp, query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = initializeApp(CONFIG.firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    /********************************************************************
     * 3) 상태
     ********************************************************************/
    const state = {
      user: null,
      isAdmin: false,
      businesses: [],
      users: [],
      leads: [],
      subs: [],
      loading: false,
      error: null,
    };

    /********************************************************************
     * 4) 유틸
     ********************************************************************/
    const $ = (sel) => document.querySelector(sel);
    const appEl = $("#app");

    function escapeHtml(s="") {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function nowIso() { return new Date().toISOString(); }

    function toast(msg, ok=true) {
      alert(msg);
    }

    function setLoading(v) { state.loading = v; render(); }

    function setError(e) { state.error = e?.message || String(e); render(); }

    function isEmailVerified(user) {
      // Firebase Auth user.emailVerified 값은 provider에 따라 다를 수 있음
      return !!user?.email;
    }

    function isAdminEmail(email) {
      return CONFIG.adminEmails.map(x => x.toLowerCase()).includes((email||"").toLowerCase());
    }

    /********************************************************************
     * 5) 데이터 모델 (Firestore)
     *
     * - public_businesses (공개 아이디어 목록)
     *   { title, desc, tags[], status('idea'|'mvp'|'launched'), link, createdAt, updatedAt, published(bool) }
     *
     * - users (로그인 사용자)
     *   docId = uid
     *   { email, displayName, photoURL, lastLoginAt, createdAt }
     *
     * - leads (문의/제출)
     *   { name, email, message, createdAt }
     *
     * - subscriptions (유료/권한)  *이 파일은 "수동 승인" MVP
     *   docId = uid
     *   { active(bool), plan, updatedAt, note }
     ********************************************************************/

    async function upsertUserProfile(user) {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          email: user.email || null,
          displayName: user.displayName || null,
          photoURL: user.photoURL || null,
          createdAt: serverTimestamp(),
          lastLoginAt: serverTimestamp(),
        });
      } else {
        await updateDoc(ref, { lastLoginAt: serverTimestamp() });
      }
    }

    async function loadBusinesses() {
      const qy = query(collection(db, "public_businesses"), orderBy("updatedAt", "desc"), limit(200));
      const res = await getDocs(qy);
      state.businesses = res.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function loadAdminData() {
      if (!state.isAdmin) return;
      const usersQ = query(collection(db, "users"), orderBy("lastLoginAt", "desc"), limit(200));
      const leadsQ = query(collection(db, "leads"), orderBy("createdAt", "desc"), limit(200));
      const subsQ  = query(collection(db, "subscriptions"), orderBy("updatedAt", "desc"), limit(200));

      const [u, l, s] = await Promise.all([getDocs(usersQ), getDocs(leadsQ), getDocs(subsQ)]);
      state.users = u.docs.map(d => ({ id: d.id, ...d.data() }));
      state.leads = l.docs.map(d => ({ id: d.id, ...d.data() }));
      state.subs  = s.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function createBusiness(data) {
      await addDoc(collection(db, "public_businesses"), {
        title: data.title,
        desc: data.desc,
        tags: data.tags,
        status: data.status,
        link: data.link || null,
        published: !!data.published,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      });
      await loadBusinesses();
      toast("등록 완료");
      render();
    }

    async function updateBusiness(id, data) {
      await updateDoc(doc(db, "public_businesses", id), {
        ...data,
        updatedAt: serverTimestamp(),
      });
      await loadBusinesses();
      toast("수정 완료");
      render();
    }

    async function removeBusiness(id) {
      if (!confirm("삭제하시겠습니까?")) return;
      await deleteDoc(doc(db, "public_businesses", id));
      await loadBusinesses();
      toast("삭제 완료");
      render();
    }

    async function submitLead(data) {
      await addDoc(collection(db, "leads"), {
        name: data.name || null,
        email: data.email || null,
        message: data.message || "",
        createdAt: serverTimestamp(),
      });
      toast("제출 완료");
    }

    async function setSubscription(uid, active, plan="pro", note="") {
      await setDoc(doc(db, "subscriptions", uid), {
        active: !!active,
        plan,
        note,
        updatedAt: serverTimestamp(),
      }, { merge: true });
      await loadAdminData();
      toast("구독 상태 업데이트 완료");
      render();
    }

    async function getMySubscription(uid) {
      const snap = await getDoc(doc(db, "subscriptions", uid));
      return snap.exists() ? snap.data() : null;
    }

    /********************************************************************
     * 6) 로그인/로그아웃
     ********************************************************************/
    async function login() {
      try {
        const res = await signInWithPopup(auth, provider);
        // 사용자 프로필 저장
        await upsertUserProfile(res.user);
        toast("로그인 성공");
      } catch (e) {
        setError(e);
      }
    }

    async function logout() {
      try {
        await signOut(auth);
        toast("로그아웃");
      } catch (e) {
        setError(e);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      state.user = user;
      state.isAdmin = !!user?.email && isAdminEmail(user.email);
      $("#userPill").textContent = user?.email ? (state.isAdmin ? `관리자: ${user.email}` : `로그인: ${user.email}`) : "로그아웃 상태";
      $("#loginBtn").style.display = user ? "none" : "inline-block";
      $("#logoutBtn").style.display = user ? "inline-block" : "none";

      try {
        if (user) await upsertUserProfile(user);
        await loadBusinesses();
        await loadAdminData();
      } catch (e) {
        setError(e);
      }
      render();
    });

    $("#loginBtn").addEventListener("click", login);
    $("#logoutBtn").addEventListener("click", logout);

    /********************************************************************
     * 7) 간단 라우터
     ********************************************************************/
    window.addEventListener("hashchange", render);

    function route() {
      const h = (location.hash || "#/").replace("#", "");
      const [path] = h.split("?");

      if (path === "/") return "home";
      if (path === "/pricing") return "pricing";
      if (path === "/submit") return "submit";
      if (path === "/admin") return "admin";
      return "home";
    }

    /********************************************************************
     * 8) 광고 슬롯 렌더(AdSense)
     ********************************************************************/
    function renderAdsUnit() {
      if (!CONFIG.enableAds) return "";
      // AdSense는 승인/정책에 따라 노출이 달라질 수 있음.
      // 실제 운영 시 Google 문서에 따라 스니펫을 맞추세요.
      return `
        <div class="card">
          <h2>광고</h2>
          <div class="muted small">AdSense 승인 후 활성화됩니다.</div>
          <div style="margin-top:10px;">
            <ins class="adsbygoogle"
              style="display:block"
              data-ad-client="${escapeHtml(CONFIG.adsenseClient)}"
              data-ad-slot="${escapeHtml(CONFIG.adsenseSlot)}"
              data-ad-format="auto"
              data-full-width-responsive="true"></ins>
          </div>
        </div>
      `;
    }

    function loadAdsScriptOnce() {
      if (!CONFIG.enableAds) return;
      if (document.getElementById("adsenseScript")) return;
      const s = document.createElement("script");
      s.id = "adsenseScript";
      s.async = true;
      s.src = `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${encodeURIComponent(CONFIG.adsenseClient)}`;
      s.crossOrigin = "anonymous";
      document.head.appendChild(s);

      // adsbygoogle push
      setTimeout(() => {
        try {
          (window.adsbygoogle = window.adsbygoogle || []).push({});
        } catch {}
      }, 1200);
    }

    /********************************************************************
     * 9) 화면들
     ********************************************************************/
    function viewHome() {
      const publicItems = state.businesses.filter(b => b.published);
      const tags = Array.from(new Set(publicItems.flatMap(x => (x.tags || [])))).slice(0, 30);

      return `
        <div class="grid">
          <div class="card">
            <h2>공개 중인 사업/아이디어</h2>
            <div class="muted">사람들이 볼 수 있는 목록입니다. (관리자만 편집 가능)</div>

            <div class="hr"></div>
            <div class="row">
              ${tags.map(t => `<span class="tag">#${escapeHtml(t)}</span>`).join("")}
            </div>

            <div class="list">
              ${publicItems.length ? publicItems.map(b => `
                <div class="item">
                  <div class="row" style="justify-content:space-between;">
                    <div class="title">${escapeHtml(b.title || "")}</div>
                    <span class="pill">${escapeHtml(b.status || "idea")}</span>
                  </div>
                  <div class="muted" style="margin-top:6px;">${escapeHtml(b.desc || "")}</div>
                  <div class="row" style="margin-top:10px;">
                    ${(b.tags||[]).slice(0,8).map(t => `<span class="tag">#${escapeHtml(t)}</span>`).join("")}
                    ${b.link ? `<a class="btn" target="_blank" rel="noopener" href="${escapeHtml(b.link)}">링크</a>` : ""}
                  </div>
                </div>
              `).join("") : `<div class="muted">아직 공개된 아이디어가 없습니다. 관리자 페이지에서 등록해 주세요.</div>`}
            </div>
          </div>

          <div class="card">
            <h2>시작하기</h2>
            <div class="muted">
              로그인 후 아이디어를 제출하거나, 결제로 프로젝트를 지원할 수 있습니다.
            </div>

            <div class="hr"></div>

            <div class="kpi">
              <div class="item">
                <div class="muted small">로그인 상태</div>
                <div style="margin-top:6px;">
                  ${state.user?.email ? `<span class="ok">ON</span>` : `<span class="bad">OFF</span>`}
                </div>
              </div>
              <div class="item">
                <div class="muted small">관리자</div>
                <div style="margin-top:6px;">
                  ${state.isAdmin ? `<span class="ok">YES</span>` : `<span class="bad">NO</span>`}
                </div>
              </div>
              <div class="item">
                <div class="muted small">결제</div>
                <div style="margin-top:6px;">
                  <span class="ok">Stripe Link</span>
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <a class="btn primary" href="#/pricing">결제/구독</a>
              <a class="btn" href="#/submit">아이디어 제출</a>
              <a class="btn" href="#/admin">관리자</a>
            </div>

            <div class="hr"></div>
            ${renderAdsUnit()}
          </div>
        </div>
      `;
    }

    function viewPricing() {
      const email = state.user?.email || "";
      const payUrl = CONFIG.stripePaymentLink
        ? `${CONFIG.stripePaymentLink}${CONFIG.stripePaymentLink.includes("?") ? "&" : "?"}prefilled_email=${encodeURIComponent(email)}`
        : "";

      return `
        <div class="grid">
          <div class="card">
            <h2>결제/구독</h2>
            <div class="muted">
              GitHub Pages는 서버 사이드 코드가 없으므로, 현재는 Stripe <b>Payment Link</b>로 결제를 처리합니다.
              <div class="small muted" style="margin-top:6px;">
                “유료 사용자 자동 권한부여(결제 검증/웹훅)”까지 하려면 서버리스(Cloudflare Worker/Firebase Functions) 추가를 권장합니다.
              </div>
            </div>

            <div class="hr"></div>

            ${state.user ? `
              <div class="row">
                <a class="btn primary" target="_blank" rel="noopener" href="${escapeHtml(payUrl)}">Stripe 결제 페이지 열기</a>
                <button class="btn" id="btnCheckSub">내 구독 상태 확인</button>
              </div>
              <div id="subStatus" class="muted small" style="margin-top:10px;"></div>
              <div class="hr"></div>
              <div class="muted small">
                결제 후 “권한 자동 반영”을 원하시면 (서버리스 + Stripe 웹훅)로 확장하세요.
              </div>
            ` : `
              <div class="muted">결제를 위해 먼저 로그인해 주세요.</div>
              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnLoginHere">Google 로그인</button>
              </div>
            `}
          </div>

          <div class="card">
            <h2>광고</h2>
            <div class="muted small">AdSense 승인 후 enableAds=true로 바꾸면 슬롯이 노출됩니다.</div>
            ${renderAdsUnit()}
          </div>
        </div>
      `;
    }

    function viewSubmit() {
      const email = state.user?.email || "";

      return `
        <div class="card">
          <h2>아이디어/문의 제출</h2>
          <div class="muted">제출 내용은 관리자 대시보드에서 확인합니다.</div>

          <div class="hr"></div>

          <div class="row" style="gap:14px;">
            <div style="flex:1;">
              <label class="small muted">이름</label>
              <input id="leadName" class="input" placeholder="이름(선택)" />
            </div>
            <div style="flex:1;">
              <label class="small muted">이메일</label>
              <input id="leadEmail" class="input" placeholder="이메일(선택)" value="${escapeHtml(email)}"/>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label class="small muted">내용</label>
            <textarea id="leadMsg" class="input" placeholder="아이디어/문의 내용을 입력해 주세요"></textarea>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn primary" id="btnSubmitLead">제출</button>
            <span class="muted small">스팸 방지를 위해 Firestore Rules/App Check를 적용하세요.</span>
          </div>
        </div>
      `;
    }

    function viewAdmin() {
      if (!state.user) {
        return `
          <div class="card">
            <h2>관리자</h2>
            <div class="muted">관리자 기능은 로그인 후 사용 가능합니다.</div>
            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="btnLoginAdmin">Google 로그인</button>
            </div>
          </div>
        `;
      }
      if (!state.isAdmin) {
        return `
          <div class="card">
            <h2>관리자</h2>
            <div class="bad">권한이 없습니다.</div>
            <div class="muted small">CONFIG.adminEmails에 본인 이메일을 추가하고 Firestore Rules도 같이 적용하세요.</div>
          </div>
        `;
      }

      const allItems = state.businesses;

      return `
        <div class="grid">
          <div class="card">
            <h2>사업/아이디어 관리</h2>
            <div class="muted small">등록/수정/삭제, 공개 여부(published)를 제어합니다.</div>

            <div class="hr"></div>

            <div class="item">
              <div class="row">
                <div style="flex:1;">
                  <label class="small muted">제목</label>
                  <input id="bTitle" class="input" placeholder="예: AI 리서치 자동화 SaaS" />
                </div>
                <div style="width:220px;">
                  <label class="small muted">상태</label>
                  <select id="bStatus" class="input">
                    <option value="idea">idea</option>
                    <option value="mvp">mvp</option>
                    <option value="launched">launched</option>
                  </select>
                </div>
              </div>

              <div style="margin-top:10px;">
                <label class="small muted">설명</label>
                <textarea id="bDesc" class="input" placeholder="핵심 가치, 타깃, 수익모델 요약"></textarea>
              </div>

              <div class="row" style="margin-top:10px;">
                <div style="flex:1;">
                  <label class="small muted">태그(콤마로 구분)</label>
                  <input id="bTags" class="input" placeholder="예: ai, automation, saas" />
                </div>
                <div style="flex:1;">
                  <label class="small muted">링크(선택)</label>
                  <input id="bLink" class="input" placeholder="https://..." />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <label class="row"><input id="bPub" type="checkbox" /> <span class="small muted">공개(published)</span></label>
                <button class="btn primary" id="btnCreateBiz">등록</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="list">
              ${allItems.length ? allItems.map(b => `
                <div class="item">
                  <div class="row" style="justify-content:space-between;">
                    <div>
                      <div class="title">${escapeHtml(b.title||"")}</div>
                      <div class="muted small">id: ${escapeHtml(b.id)} / status: ${escapeHtml(b.status||"")}</div>
                    </div>
                    <div class="row">
                      <span class="pill">${b.published ? "공개" : "비공개"}</span>
                      <button class="btn" data-act="edit" data-id="${escapeHtml(b.id)}">편집</button>
                      <button class="btn danger" data-act="del" data-id="${escapeHtml(b.id)}">삭제</button>
                    </div>
                  </div>
                  <div class="muted" style="margin-top:6px;">${escapeHtml(b.desc||"")}</div>
                  <div class="row" style="margin-top:10px;">
                    ${(b.tags||[]).slice(0,10).map(t => `<span class="tag">#${escapeHtml(t)}</span>`).join("")}
                    ${b.link ? `<a class="btn" target="_blank" rel="noopener" href="${escapeHtml(b.link)}">링크</a>` : ""}
                  </div>
                </div>
              `).join("") : `<div class="muted">등록된 아이디어가 없습니다.</div>`}
            </div>
          </div>

          <div class="card">
            <h2>운영/관리</h2>
            <div class="muted small">사용자/리드/구독(수동 승인) 관리</div>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px;">최근 사용자</h3>
            <div class="list">
              ${state.users.slice(0, 10).map(u => `
                <div class="item">
                  <div class="title">${escapeHtml(u.email||"(no email)")}</div>
                  <div class="muted small">uid: ${escapeHtml(u.id)}</div>
                  <div class="muted small">lastLogin: ${escapeHtml(String(u.lastLoginAt?.toDate?.() || ""))}</div>
                  <div class="row" style="margin-top:8px;">
                    <button class="btn" data-act="subOn" data-uid="${escapeHtml(u.id)}">구독 ON</button>
                    <button class="btn danger" data-act="subOff" data-uid="${escapeHtml(u.id)}">구독 OFF</button>
                  </div>
                </div>
              `).join("") || `<div class="muted">사용자 데이터가 없습니다.</div>`}
            </div>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px;">최근 제출(리드)</h3>
            <div class="list">
              ${state.leads.slice(0, 10).map(l => `
                <div class="item">
                  <div class="title">${escapeHtml(l.name||"(no name)")}</div>
                  <div class="muted small">${escapeHtml(l.email||"(no email)")}</div>
                  <div class="muted" style="margin-top:6px;">${escapeHtml(l.message||"")}</div>
                </div>
              `).join("") || `<div class="muted">제출이 없습니다.</div>`}
            </div>

            <div class="hr"></div>

            <div class="small muted">
              ※ “결제 완료 자동 반영”은 Stripe 웹훅이 필요합니다(정적 Pages만으로는 불가).<br/>
              ※ 보안을 위해 Firestore Rules와 App Check 적용을 강력 권장합니다.
            </div>
          </div>
        </div>
      `;
    }

    /********************************************************************
     * 10) 이벤트 바인딩
     ********************************************************************/
    function bindCommonHandlers() {
      // pricing: 로그인/구독 확인
      const btnLoginHere = $("#btnLoginHere");
      if (btnLoginHere) btnLoginHere.addEventListener("click", login);

      const btnCheckSub = $("#btnCheckSub");
      if (btnCheckSub) btnCheckSub.addEventListener("click", async () => {
        if (!state.user) return;
        const sub = await getMySubscription(state.user.uid);
        $("#subStatus").textContent = sub?.active ? `✅ 활성 구독: ${sub.plan || "pro"}` : "❌ 활성 구독 없음(또는 미승인)";
      });

      // submit lead
      const btnSubmitLead = $("#btnSubmitLead");
      if (btnSubmitLead) btnSubmitLead.addEventListener("click", async () => {
        try {
          const name = $("#leadName").value.trim();
          const email = $("#leadEmail").value.trim();
          const message = $("#leadMsg").value.trim();
          if (!message) return toast("내용을 입력해 주세요.", false);
          await submitLead({ name, email, message });
          $("#leadMsg").value = "";
        } catch (e) { setError(e); }
      });

      // admin login
      const btnLoginAdmin = $("#btnLoginAdmin");
      if (btnLoginAdmin) btnLoginAdmin.addEventListener("click", login);

      // admin create business
      const btnCreateBiz = $("#btnCreateBiz");
      if (btnCreateBiz) btnCreateBiz.addEventListener("click", async () => {
        try {
          const title = $("#bTitle").value.trim();
          const desc = $("#bDesc").value.trim();
          const tags = $("#bTags").value.split(",").map(s => s.trim()).filter(Boolean);
          const status = $("#bStatus").value;
          const link = $("#bLink").value.trim();
          const published = $("#bPub").checked;

          if (!title || !desc) return toast("제목/설명을 입력해 주세요.", false);
          await createBusiness({ title, desc, tags, status, link, published });

          $("#bTitle").value = "";
          $("#bDesc").value = "";
          $("#bTags").value = "";
          $("#bLink").value = "";
          $("#bPub").checked = false;
        } catch (e) { setError(e); }
      });

      // admin list actions
      appEl.querySelectorAll("[data-act]").forEach(el => {
        el.addEventListener("click", async (ev) => {
          const act = el.getAttribute("data-act");
          const id = el.getAttribute("data-id");
          const uid = el.getAttribute("data-uid");

          try {
            if (act === "del" && id) return await removeBusiness(id);
            if (act === "edit" && id) {
              const b = state.businesses.find(x => x.id === id);
              if (!b) return;

              const newTitle = prompt("제목", b.title || "") ?? b.title;
              const newDesc  = prompt("설명", b.desc || "") ?? b.desc;
              const newTags  = prompt("태그(콤마)", (b.tags||[]).join(",")) ?? (b.tags||[]).join(",");
              const newStatus= prompt("상태(idea/mvp/launched)", b.status || "idea") ?? b.status;
              const newLink  = prompt("링크(선택)", b.link || "") ?? b.link;
              const newPub   = confirm("공개로 설정할까요? (확인=공개 / 취소=비공개)");

              await updateBusiness(id, {
                title: newTitle.trim(),
                desc: newDesc.trim(),
                tags: newTags.split(",").map(s => s.trim()).filter(Boolean),
                status: newStatus.trim(),
                link: newLink.trim() || null,
                published: newPub,
              });
              return;
            }

            if (act === "subOn" && uid) return await setSubscription(uid, true, "pro", "admin_manual");
            if (act === "subOff" && uid) return await setSubscription(uid, false, "pro", "admin_manual_off");

          } catch (e) { setError(e); }
        });
      });
    }

    /********************************************************************
     * 11) 렌더
     ********************************************************************/
    function render() {
      // 광고 스크립트 조건부 로드
      loadAdsScriptOnce();

      const r = route();
      const body =
        r === "home" ? viewHome()
      : r === "pricing" ? viewPricing()
      : r === "submit" ? viewSubmit()
      : r === "admin" ? viewAdmin()
      : viewHome();

      appEl.innerHTML = `
        ${state.error ? `<div class="card"><div class="bad">에러: ${escapeHtml(state.error)}</div></div><div class="hr"></div>` : ""}
        ${body}
        <div class="hr"></div>
        <div class="muted small">
          <b>보안 메모</b>: GitHub Pages는 정적 호스팅이므로 서버 비밀키(Stripe secret key 등)를 이 파일에 넣으면 즉시 노출됩니다.
          결제 검증/권한부여 자동화는 서버리스(Worker/Functions)로 확장하세요.
        </div>
      `;

      bindCommonHandlers();

      // AdSense push (슬롯 렌더 후)
      if (CONFIG.enableAds) {
        setTimeout(() => {
          try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } catch {}
        }, 800);
      }
    }

    render();

    /********************************************************************
     * 12) Firestore Security Rules (Firebase 콘솔에서 별도로 설정해야 함)
     * - 아래는 "관리자 이메일 allowlist" 기반의 MVP 예시
     * - request.auth.token.email / email_verified 같은 Auth 필드 개념은 Firebase 문서 참고
     ********************************************************************
     *
     * rules_version = '2';
     * service cloud.firestore {
     *   match /databases/{database}/documents {
     *     function isAdmin() {
     *       return request.auth != null
     *         && request.auth.token.email_verified == true
     *         && (request.auth.token.email in ["admin@example.com"]);
     *     }
     *
     *     match /public_businesses/{docId} {
     *       allow read: if true;
     *       allow write: if isAdmin();
     *     }
     *
     *     match /users/{uid} {
     *       allow read: if isAdmin();
     *       allow write: if request.auth != null && request.auth.uid == uid;
     *     }
     *
     *     match /leads/{docId} {
     *       allow create: if true;    // 스팸 우려 시 App Check/레이트리밋 고려
     *       allow read, update, delete: if isAdmin();
     *     }
     *
     *     match /subscriptions/{uid} {
     *       allow read: if request.auth != null && request.auth.uid == uid;
     *       allow write: if isAdmin();
     *     }
     *   }
     * }
     *
     ********************************************************************/
  </script>
</body>
</html>
